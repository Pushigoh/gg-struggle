# NOTE: This must be run as admin!

$storeMy = "Cert:\LocalMachine\My"
$storeRoot = "Cert:\LocalMachine\Root"
$outputDir = Resolve-Path $args[0]
$hash = Get-Random
$keyLocation = "$outputDir\$hash"

if (($args.Count -lt 1) -or !(Test-Path $outputDir)) {
  Write-Host "Usage: gencert.ps1 <outputDir>"
  Exit -1
}


# Generate self-signed cert, and key
New-SelfSignedCertificate `
  -KeyLength 4096 `
  -DnsName "ggst-game.guiltygear.com", "localhost" `
  -CertStoreLocation $storeMy `
  -KeyLocation $keyLocation `
  -KeyFriendlyName "generated by gg-struggle/tools/gencert.ps1" `
  -KeyDescription "gg-struggle-key" `
  -FriendlyName "gg-struggle" `

# Move key to output directory as "gg-struggle.key"
$keyName = Get-ChildItem "$keyLocation\Keys"
$keySrc = "$keyLocation\Keys\$keyName"
$keyDst = "$outputDir\gg-struggle.key"

Write-Host $key
Write-Host "Moving $keySrc to $outputDir\gg-struggle.key"
Move-Item -Path "$keySrc" -Destination "$keyDst" -Force

# Copy cert to output directory
$cert = Get-ChildItem $storeMy `
 | where{$_.Subject -eq "CN=ggst-game.guiltygear.com"}


if ($cert.Count -gt 1) {
Write-Host $cert[0]
  Write-Error "Multiple certs found. Run 'rmcert.ps1' and try re-running this script."
  Exit 1
}
if ($cert.Count -eq 1) {
  Export-Certificate -Cert $cert -Type CERT -FilePath "$outputDir\gg-struggle.cert"
}


# Install cert from the My store into Root store
$certId = $cert.Thumbprint
Write-Host "Installed $storeRoot\$certId to $storeRoot "
Move-Item -path $storeMy\$certId -Destination $storeRoot
